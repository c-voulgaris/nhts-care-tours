---
title: "analysis"
execute:
  message: false
  warning: false
format:
  html:
    theme: minty
    toc: true
    toc-location: left
editor: visual
---

The purpose of this page is to check the sample size of tours by adults in 
households with children under 9 from the 2017 NHTS.

# Load data

Data downloaded to `data` folder (listed in .gitignore) from https://nhts.ornl.gov/media/2016/download/csv.zip


```{r}
library(here)
library(tidyverse)
library(knitr)

trips <- here("data",
              "trippub.csv") |>
  read_csv()

people <- here("data",
               "perpub.csv") |>
  read_csv()

hhs <- here("data",
            "hhpub.csv") |>
  read_csv()

```

# Identify sample of trips

Identify all households with children between 5 and 9 (no one under 5 is 
included in the people file).

```{r}

kid_hh_5to9 <- people |>
  filter(R_AGE < 10,
         R_AGE > 0) |>
  group_by(HOUSEID) |>
  summarise(n = n())

```

Filter households to only include those with children under 10.

```{r}

kid_hh <- hhs |>
  filter(YOUNGCHILD > 0 | HOUSEID %in% kid_hh_5to9$HOUSEID)

```

Filter trips to only include those by households with kids under 10, where the 
traveler is between 23 and 69 years old, and the trip begins at home (there
would be one of these for every home-based tour).

```{r}

kid_hh_trips <- trips |>
  filter(HOUSEID %in% kid_hh$HOUSEID,
         R_AGE > 22,
         R_AGE < 70) |>
  mutate(home_start = WHYFROM %in% c("01", "02"),
         home_end = WHYTO %in% c("01", "02")) |>
  select(HOUSEID, PERSONID, 
         TDTRPNUM, STRTTIME, ENDTIME,
         TRPMILES, WHYTO, WHYFROM,
         home_start, home_end) |>
  mutate(trip_num = row_number())
  
```



# Constructing tours

Not sure if this is the best approach, but it's one possible approach.

```{r}

tours <- kid_hh_trips |>
  filter(home_start | TDTRPNUM == "01") |>
  rename(start_trip_num = trip_num) |>
  mutate(tour_num = row_number())

tour_ends <- kid_hh_trips |>
  filter(home_end)

end_trip_num <- c(tours$start_trip_num[2:nrow(tours)] - 1,
                  tour_ends$trip_num[nrow(tour_ends)])

tours <- tours |>
  mutate(end_trip_num = end_trip_num) |>
  mutate(num_trips = end_trip_num - start_trip_num +1)

tour_nums <- rep(tours$tour_num, times = tours$num_trips)

kid_hh_trips <- kid_hh_trips |>
  mutate(tour_num = tour_nums) |>
  mutate(hrs_from_4am_trip_start = 
           as.numeric(substr(STRTTIME, 1, 2)) - 4) |> # survey day starts at 4am
  mutate(hrs_from_4am_trip_start = ifelse(hrs_from_4am_trip_start < 0,
                                          hrs_from_4am_trip_start + 24,
                                          hrs_from_4am_trip_start)) |>
  mutate(mins_from_4am_trip_start = 
           as.numeric(substr(STRTTIME, 3, 4)) + 
           (60 * hrs_from_4am_trip_start)) |>
  mutate(hrs_from_4am_trip_end = 
           as.numeric(substr(ENDTIME, 1, 2)) - 4) |> # survey day starts at 4am
  mutate(hrs_from_4am_trip_end = ifelse(hrs_from_4am_trip_end < 0,
                                          hrs_from_4am_trip_end + 24,
                                          hrs_from_4am_trip_end)) |>
  mutate(mins_from_4am_trip_end = 
           as.numeric(substr(ENDTIME, 3, 4)) +
                        (60 * hrs_from_4am_trip_end)) 

next_trip <- c(kid_hh_trips$mins_from_4am_trip_start[2:nrow(kid_hh_trips)], 0)

kid_hh_trips <- kid_hh_trips |>
  mutate(next_trip = next_trip) |>
  mutate(trip_time = mins_from_4am_trip_end - mins_from_4am_trip_start) |>
  mutate(time_at_dest = ifelse(home_end, 0,
                               next_trip - mins_from_4am_trip_end)) 

open_tours <- kid_hh_trips[kid_hh_trips$time_at_dest < 0,]$tour_num

kid_hh_trips <- kid_hh_trips |>
  filter(!tour_num %in% open_tours)
  
kid_hh_tours <- kid_hh_trips |>
  group_by(HOUSEID, PERSONID, tour_num) |>
  mutate(max_activity_time = max(time_at_dest)) |>
  mutate(main_purp = ifelse(time_at_dest == max_activity_time,
                            WHYTO, "zzz")) |>
  summarise(travel_time = sum(trip_time),
            tour_purp = min(main_purp),
            activity_time = sum(time_at_dest),
            num_trips = n()) |>
  filter(num_trips > 1,
         tour_purp != "-7",
         tour_purp != "-8")

nrow(kid_hh_tours)

```

Final sample of 37,017 tours.
